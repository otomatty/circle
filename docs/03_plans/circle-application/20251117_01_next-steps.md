# Circleアプリケーション 今後の実装プラン

## 作成日
2025年11月17日

## 概要
SQLite移行が完了し、基本的な動作確認ができた状態から、アプリケーションの機能拡張と改善を進めるための実装プランです。

## 現在の状態

### 完了した作業
- ✅ SupabaseからSQLiteへの移行
- ✅ 認証機能の削除
- ✅ `@kit/*`パッケージの削除とshadcn/uiへの置き換え
- ✅ i18nのカスタム実装
- ✅ データベーススキーマの実装
- ✅ シードデータの実装
- ✅ Server ActionsのSQLite対応
- ✅ 基本的な動作確認
- ✅ データベースマイグレーション機能の実装（Phase 6.1）
- ✅ エラーハンドリングの強化（Phase 6.5）

### 既知の問題・制限事項
1. **Gmail機能の無効化**: `lib/server/gmail/service.ts`がコメントアウトされています
2. **認証なし**: 現在は誰でもアクセス可能な状態です
3. ~~**データベースマイグレーション**: スキーマ変更時のマイグレーション機能が未実装~~ ✅ 実装完了

## Phase 6: 機能の実装と改善

### 6.1 データベースマイグレーション機能の実装 ✅

**GitHub Issue**: [#1](https://github.com/otomatty/circle/issues/1)

**目的**: スキーマ変更を安全に管理する

**実装内容:**
- [x] マイグレーション管理システムの実装
  - マイグレーションファイルの管理
  - マイグレーション実行履歴の記録
  - ロールバック機能（オプション）
- [x] `scripts/migrate.ts`の作成
- [x] マイグレーション実行スクリプトの追加（`package.json`）

**実装完了日**: 2025年11月17日

**実装内容詳細:**
- `lib/db/migrate.ts`: マイグレーション管理機能を実装
- `scripts/migrate.ts`: マイグレーション実行スクリプトを作成
- `lib/db/migrations/`: マイグレーションファイル用ディレクトリを作成
- `lib/db/migrations/20251117000000_initial_schema.sql`: 初期スキーマのマイグレーションファイルを作成
- `package.json`: 以下のスクリプトを追加
  - `db:migrate`: 未実行のマイグレーションを実行
  - `db:migrate:status`: マイグレーションの状態を表示
  - `db:migrate:rollback`: 最後のマイグレーションをロールバック

**参考:**
- `lib/db/migrations/`ディレクトリの作成 ✅
- マイグレーションバージョン管理テーブルの追加 ✅

### 6.2 Gmail機能の復旧

**GitHub Issue**: [#6](https://github.com/otomatty/circle/issues/6)

**目的**: Gmail連携機能をSQLite対応で復旧

**実装内容:**
- [ ] SQLiteスキーマにGmail関連テーブルの追加
  - `gmail_messages`テーブル
  - `gmail_attachments`テーブル
  - `gmail_labels`テーブル
- [ ] `lib/server/gmail/service.ts`の修正
  - SupabaseクライアントをSQLiteクエリに置き換え
  - メール同期機能の実装
  - メール送信機能の実装
- [ ] Gmail API認証の実装（OAuth2）

**注意事項:**
- Gmail APIの認証情報が必要
- 環境変数に`GMAIL_CLIENT_ID`、`GMAIL_CLIENT_SECRET`などを追加

### 6.3 認証機能の実装（オプション）

**GitHub Issue**: [#7](https://github.com/otomatty/circle/issues/7)

**目的**: 必要に応じて認証機能を追加

**実装内容:**
- [ ] 認証方式の選定
  - NextAuth.js
  - Clerk
  - カスタム実装
- [ ] 認証テーブルの追加
  - `sessions`テーブル
  - `accounts`テーブル（OAuth連携用）
- [ ] 認証ミドルウェアの実装
- [ ] 認証ページの実装

**注意事項:**
- 現在は認証なしで動作しているため、必須ではない
- 必要に応じて段階的に実装

### 6.4 パフォーマンス最適化

**GitHub Issue**: [#2](https://github.com/otomatty/circle/issues/2)

**目的**: アプリケーションのパフォーマンスを向上させる

**実装内容:**
- [ ] データベースクエリの最適化
  - インデックスの追加
  - N+1クエリ問題の解決
  - クエリキャッシュの実装
- [ ] 画像最適化
  - Next.js Imageコンポーネントの活用
  - 画像の遅延読み込み
- [ ] バンドルサイズの最適化
  - コード分割の見直し
  - 不要な依存関係の削除

### 6.5 エラーハンドリングの強化 ✅

**GitHub Issue**: [#3](https://github.com/otomatty/circle/issues/3)

**GitHub PR**: [#13](https://github.com/otomatty/circle/pull/13)

**目的**: エラー処理を統一し、ユーザー体験を向上させる

**実装内容:**
- [x] エラータイプとエラークラスの作成
  - `lib/errors/types.ts`: アプリケーション全体で使用するエラータイプとインターフェース定義
  - `lib/errors/server.ts`: サーバーサイド用のエラークラス（DatabaseError, ValidationError, NotFoundError等）
  - `lib/errors/client.ts`: クライアントサイド用のエラークラス（NetworkError等）
- [x] エラーログの実装
  - `lib/errors/logger.ts`: 構造化されたエラーログ機能
  - 開発環境と本番環境で異なるログ出力
  - サーバーサイドとクライアントサイドのログ実装
- [x] エラーハンドリングユーティリティ
  - `lib/errors/handler.ts`: Server Actions用のエラーハンドリングラッパー
  - `handleServerAction`: 統一的なエラーハンドリング
  - `handleDatabaseAction`: データベース操作用のエラーハンドリング
  - better-sqlite3の`SqliteError`検出ロジック
- [x] エラーメッセージの国際化
  - `public/locales/ja/errors.json`: 日本語エラーメッセージ
  - `public/locales/en/errors.json`: 英語エラーメッセージ
  - `lib/errors/i18n.ts`: エラーメッセージのi18nユーティリティ
  - `lib/i18n/i18n.settings.ts`: errors名前空間を追加
- [x] エラーバウンダリーの実装
  - `app/error.tsx`: i18n対応、エラーログ記録、開発環境での詳細情報表示
  - `app/global-error.tsx`: i18n対応、エラーログ記録
  - `hooks/useErrorHandler.ts`: AppError型の修正、i18n対応のエラーメッセージ表示
- [x] Server Actionsのエラーハンドリング統一
  - すべてのServer Actionsファイルに統一的なエラーハンドリングを適用
  - `actions/issues.ts`, `actions/users.ts`, `actions/teams.ts`, `actions/projects.ts`, `actions/labels.ts`, `actions/priorities.ts`, `actions/status.ts`

**実装完了日**: 2025年11月19日

**実装内容詳細:**
- **エラータイプとエラークラス**:
  - `lib/errors/types.ts`: `AppError`インターフェース、`ErrorCode`、`ErrorLevel`型定義、`isAppError`、`toAppError`ユーティリティ関数
  - `lib/errors/server.ts`: `ServerError`、`DatabaseError`、`ValidationError`、`NotFoundError`、`UnauthorizedError`、`ForbiddenError`クラス
  - `lib/errors/client.ts`: `ClientError`、`NetworkError`クラス
  - `lib/errors/index.ts`: エラーハンドリングモジュールの統一エクスポート

- **エラーログ機能**:
  - `lib/errors/logger.ts`: 構造化ログ機能、環境別ログ出力、`logServerError`、`logClientError`関数

- **エラーハンドリングユーティリティ**:
  - `lib/errors/handler.ts`: `handleServerAction`、`handleDatabaseAction`、`handleValidation`関数
  - better-sqlite3の`SqliteError`検出（`code`プロパティが`SQLITE_`で始まる、または`name`が`SqliteError`）
  - `instanceof`チェックを優先的に使用

- **エラーメッセージの国際化**:
  - `public/locales/ja/errors.json`: 日本語エラーメッセージ（全エラータイプとServer Actions用メッセージ）
  - `public/locales/en/errors.json`: 英語エラーメッセージ（全エラータイプとServer Actions用メッセージ）
  - `lib/errors/i18n.ts`: `getErrorI18nKey`、`getErrorMessage`関数

- **エラーバウンダリー**:
  - `app/error.tsx`: i18n対応、エラーログ記録、開発環境での詳細情報表示、ページリロード機能
  - `app/global-error.tsx`: i18n対応、エラーログ記録、開発環境での詳細情報表示
  - `hooks/useErrorHandler.ts`: i18n対応のエラーメッセージ表示、エラーログ記録

- **Server Actionsの統一**:
  - すべてのServer Actionsファイルに`handleDatabaseAction`ラッパーを適用
  - 統一的なエラーハンドリングとログ記録

**レビュー対応:**
- コードレビューで指摘された点をすべて対応
  - 重複コードの削除（`logger.ts`の`isAppError`、`toAppError`関数）
  - 型安全性の向上（`level`プロパティを`ErrorLevel`型に変更、`as any`キャストの削除）
  - エラー判定の改善（`instanceof`チェックとbetter-sqlite3エラーコードの活用）

### 6.6 テストの実装

**GitHub Issue**: [#4](https://github.com/otomatty/circle/issues/4)

**目的**: コードの品質を保証する

**実装内容:**
- [ ] 単体テストの実装
  - Server Actionsのテスト
  - ユーティリティ関数のテスト
- [ ] 統合テストの実装
  - データベース操作のテスト
  - APIエンドポイントのテスト
- [ ] E2Eテストの実装（オプション）
  - PlaywrightまたはCypressを使用

**テストフレームワーク:**
- Vitest（単体テスト・統合テスト）
- Playwright（E2Eテスト）

### 6.7 UI/UXの改善

**GitHub Issue**: [#5](https://github.com/otomatty/circle/issues/5)

**目的**: ユーザー体験を向上させる

**実装内容:**
- [ ] ローディング状態の改善
  - スケルトンローダーの実装
  - プログレスインジケーター
- [ ] エラーメッセージの改善
  - ユーザーフレンドリーなエラーメッセージ
  - エラー回復の提案
- [ ] アクセシビリティの向上
  - ARIA属性の追加
  - キーボードナビゲーションの改善
  - スクリーンリーダー対応

### 6.8 ドキュメントの整備

**GitHub Issue**: [#8](https://github.com/otomatty/circle/issues/8)

**目的**: 開発者向けドキュメントを充実させる

**実装内容:**
- [ ] APIドキュメントの作成
  - Server Actionsのドキュメント
  - データベーススキーマのドキュメント
- [ ] 開発ガイドの作成
  - セットアップ手順
  - 開発ワークフロー
  - コーディング規約
- [ ] コンポーネントドキュメントの作成
  - Storybookの導入（オプション）

## Phase 7: 本番環境への準備

### 7.1 環境変数の管理

**GitHub Issue**: [#9](https://github.com/otomatty/circle/issues/9)

**目的**: 環境変数を適切に管理する

**実装内容:**
- [ ] `.env.example`の更新
- [ ] 環境変数のバリデーション
- [ ] 環境変数のドキュメント化

### 7.2 デプロイメント設定

**GitHub Issue**: [#10](https://github.com/otomatty/circle/issues/10)

**目的**: 本番環境へのデプロイを準備する

**実装内容:**
- [ ] デプロイメントプラットフォームの選定
  - Vercel
  - Railway
  - その他
- [ ] CI/CDパイプラインの実装
  - GitHub Actions
  - 自動テスト
  - 自動デプロイ
- [ ] データベースのバックアップ戦略
  - 定期的なバックアップ
  - バックアップからの復旧手順

### 7.3 セキュリティ対策

**GitHub Issue**: [#11](https://github.com/otomatty/circle/issues/11)

**目的**: アプリケーションのセキュリティを強化する

**実装内容:**
- [ ] セキュリティヘッダーの設定
- [ ] CSRF対策
- [ ] XSS対策
- [ ] SQLインジェクション対策（パラメータ化クエリの徹底）
- [ ] レート制限の実装（必要に応じて）

## 優先順位

### 高優先度
1. ~~**データベースマイグレーション機能**（Phase 6.1）~~ ✅ 完了
   - スキーマ変更を安全に管理するために必要
2. ~~**エラーハンドリングの強化**（Phase 6.5）~~ ✅ 完了
   - ユーザー体験に直接影響
3. **パフォーマンス最適化**（Phase 6.4）
   - 特にデータベースクエリの最適化

### 中優先度
4. **テストの実装**（Phase 6.6）
   - コードの品質保証
5. **UI/UXの改善**（Phase 6.7）
   - ユーザー体験の向上
6. **Gmail機能の復旧**（Phase 6.2）
   - 機能の完全性

### 低優先度
7. **認証機能の実装**（Phase 6.3）
   - 現在は認証なしで動作しているため
8. **ドキュメントの整備**（Phase 6.8）
   - 継続的に改善

## 実装スケジュール（目安）

- **Week 1-2**: Phase 6.1（マイグレーション機能） ✅ 完了（2025年11月17日）
- **Week 3-4**: Phase 6.4（パフォーマンス最適化）
- **Week 5-6**: Phase 6.5（エラーハンドリング） ✅ 完了（2025年11月19日）
- **Week 7-8**: Phase 6.6（テスト実装）
- **Week 9-10**: Phase 6.7（UI/UX改善）
- **Week 11-12**: Phase 7（本番環境準備）

## 注意事項

1. **段階的な実装**: 一度にすべてを実装せず、優先順位に従って段階的に進める
2. **テスト**: 各機能の実装後、必ずテストを実施する
3. **ドキュメント**: 実装と同時にドキュメントも更新する
4. **フィードバック**: ユーザーフィードバックを収集し、優先順位を調整する

## GitHub Issues

以下のGitHub issueで各タスクを管理しています：

### Phase 6: 機能の実装と改善
- [#1](https://github.com/otomatty/circle/issues/1) - [Phase 6.1] データベースマイグレーション機能の実装
- [#2](https://github.com/otomatty/circle/issues/2) - [Phase 6.4] パフォーマンス最適化
- [#3](https://github.com/otomatty/circle/issues/3) - [Phase 6.5] エラーハンドリングの強化
- [#4](https://github.com/otomatty/circle/issues/4) - [Phase 6.6] テストの実装
- [#5](https://github.com/otomatty/circle/issues/5) - [Phase 6.7] UI/UXの改善
- [#6](https://github.com/otomatty/circle/issues/6) - [Phase 6.2] Gmail機能の復旧
- [#7](https://github.com/otomatty/circle/issues/7) - [Phase 6.3] 認証機能の実装（オプション）
- [#8](https://github.com/otomatty/circle/issues/8) - [Phase 6.8] ドキュメントの整備

### Phase 7: 本番環境への準備
- [#9](https://github.com/otomatty/circle/issues/9) - [Phase 7.1] 環境変数の管理
- [#10](https://github.com/otomatty/circle/issues/10) - [Phase 7.2] デプロイメント設定
- [#11](https://github.com/otomatty/circle/issues/11) - [Phase 7.3] セキュリティ対策

## 参考資料

- 移行計画書: `MIGRATION_PLAN.md`
- 作業ログ: `docs/05_logs/2025_11/20251117/01_circle-migration-to-sqlite.md`
- SQLiteスキーマ: `lib/db/schema.sql`
- SQLiteクライアント: `lib/db/client.ts`
- エラーハンドリングモジュール: `lib/errors/`
  - エラータイプ: `lib/errors/types.ts`
  - サーバーサイドエラー: `lib/errors/server.ts`
  - クライアントサイドエラー: `lib/errors/client.ts`
  - エラーログ: `lib/errors/logger.ts`
  - エラーハンドラー: `lib/errors/handler.ts`
  - i18nユーティリティ: `lib/errors/i18n.ts`

